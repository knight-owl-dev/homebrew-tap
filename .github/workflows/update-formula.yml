name: Update Formula

# Security note: Both workflow_dispatch inputs and repository_dispatch payloads
# are treated as untrusted. Inputs are passed via env vars (not interpolated)
# and validated by update-formula-many.sh. The repository_dispatch event can
# be triggered by anyone with write access to the repository.
#
on:
  workflow_dispatch:
    inputs:
      formulas:
        description: 'Formula specs (e.g., "keystone-cli" or "keystone-cli:0.2.0"). Leave empty to update all.'
        required: false
        type: string
  repository_dispatch:
    types: [release-published]

concurrency:
  group: update-formula
  cancel-in-progress: false

jobs:
  update:
    runs-on: macos-latest
    permissions:
      contents: read

    steps:
      - name: Configure git defaults
        run: git config --global init.defaultBranch main

      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build formula arguments
        id: args
        env:
          # Pass untrusted inputs via env vars to prevent script injection
          INPUT_FORMULAS: ${{ inputs.formulas }}
          PAYLOAD_FORMULAS: ${{ github.event.client_payload.formulas }}
        run: |
          if [ -n "${INPUT_FORMULAS}" ]
          then
            # Use workflow_dispatch input
            echo "formulas=${INPUT_FORMULAS}" >> "${GITHUB_OUTPUT}"
          elif [ -n "${PAYLOAD_FORMULAS}" ]
          then
            # Use repository_dispatch payload
            echo "formulas=${PAYLOAD_FORMULAS}" >> "${GITHUB_OUTPUT}"
          else
            # Fetch latest for all formulas
            echo "formulas=" >> "${GITHUB_OUTPUT}"
          fi

      - name: Update formulas
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORMULAS: ${{ steps.args.outputs.formulas }}
        run: |
          # shellcheck disable=SC2086
          # Word splitting is intentional: script expects space-separated formula arguments
          ./scripts/update-formula-many.sh ${FORMULAS}

      - name: Run brew test-bot syntax check
        run: |
          brew developer on
          brew test-bot --only-tap-syntax

      - name: Create PR with changes
        env:
          # Use PAT to trigger CI workflow on PR (GITHUB_TOKEN doesn't trigger workflows)
          GH_TOKEN: ${{ secrets.PR_TOKEN }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: ./scripts/create-update-pr.sh
