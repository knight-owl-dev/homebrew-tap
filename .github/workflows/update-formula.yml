name: Update Formula

# Security note: Both workflow_dispatch inputs and repository_dispatch payloads
# are treated as untrusted. All inputs are validated against a safe character
# regex before use. The repository_dispatch event can be triggered by anyone
# with write access to the repository.
#
on:
  workflow_dispatch:
    inputs:
      formulas:
        description: 'Formula specs (e.g., "keystone-cli" or "keystone-cli:0.2.0"). Leave empty to update all.'
        required: false
        type: string
  repository_dispatch:
    types: [release-published]

concurrency:
  group: update-formula
  cancel-in-progress: false

jobs:
  update:
    runs-on: macos-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build formula arguments
        id: args
        env:
          # Pass untrusted inputs via env vars to prevent script injection
          INPUT_FORMULAS: ${{ inputs.formulas }}
          PAYLOAD_FORMULAS: ${{ github.event.client_payload.formulas }}
        run: |
          if [ -n "${INPUT_FORMULAS}" ]
          then
            # Use workflow_dispatch input
            echo "formulas=${INPUT_FORMULAS}" >> "${GITHUB_OUTPUT}"
          elif [ -n "${PAYLOAD_FORMULAS}" ]
          then
            # Use repository_dispatch payload
            echo "formulas=${PAYLOAD_FORMULAS}" >> "${GITHUB_OUTPUT}"
          else
            # Fetch latest for all formulas
            echo "formulas=" >> "${GITHUB_OUTPUT}"
          fi

      - name: Update formulas
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORMULAS: ${{ steps.args.outputs.formulas }}
        run: |
          # Validate each formula spec contains only safe characters.
          # Multiple formulas are separated by spaces (e.g., "pkg1:1.0.0 pkg2:2.0.0").
          # Stricter per-formula validation (name, version format) happens in update-formula-many.sh.
          if [ -n "${FORMULAS}" ]
          then
            # shellcheck disable=SC2086
            set -- ${FORMULAS}
            for formula in "$@"
            do
              if ! printf '%s\n' "${formula}" | grep -Eq '^[A-Za-z0-9:.-]*$'
              then
                echo "Error: Invalid characters in formula spec: '${formula}'" >&2
                echo "Allowed: letters, digits, colon, dot, dash" >&2
                exit 1
              fi
            done
            echo "Updating formulas: $*"
            ./scripts/update-formula-many.sh "$@"
          else
            echo "Updating formulas: all"
            ./scripts/update-formula-many.sh
          fi

      - name: Run brew test-bot syntax check
        run: |
          brew developer on
          brew test-bot --only-tap-syntax

      - name: Create PR with changes
        env:
          # Use PAT to trigger CI workflow on PR (GITHUB_TOKEN doesn't trigger workflows)
          GH_TOKEN: ${{ secrets.PR_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Manifests/

          if git diff --staged --quiet
          then
            echo "No changes to commit"
            exit 0
          fi

          # Collect updated formulas and versions for commit message
          UPDATES=""
          for file in $(git diff --staged --name-only)
          do
            formula=$(basename "${file}" .rb)
            version=$(grep -E '^\s*VERSION\s*=' "${file}" | sed 's/.*"\(.*\)".*/\1/')
            if [ -n "${UPDATES}" ]
            then
              UPDATES="${UPDATES}, "
            fi
            UPDATES="${UPDATES}${formula} to ${version}"
          done

          # Create branch with run ID (globally unique)
          BRANCH="auto-update-formula/${GITHUB_RUN_ID}"
          git checkout -b "${BRANCH}"

          # Commit changes
          if [ -n "${UPDATES}" ]
          then
            TITLE="Update ${UPDATES}"
          else
            TITLE="Update formulas"
          fi
          git commit -m "${TITLE}"

          # Push and create PR
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
          git push -u origin "${BRANCH}"

          PR_URL=$(gh pr create --title "${TITLE}" --body "Automated formula update. \`brew test-bot --only-tap-syntax\` passed.")

          echo "Created PR: ${PR_URL}"

          # Enable auto-merge (squash)
          if ! gh pr merge --auto --squash "${PR_URL}"
          then
            echo "Failed to enable auto-merge for PR: ${PR_URL}"
            echo "Ensure auto-merge is enabled in repository settings and branch protection allows it."
            exit 1
          fi
